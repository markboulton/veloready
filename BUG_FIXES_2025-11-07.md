# Bug Fixes - November 7, 2025

## Summary
Fixed 4 UI bugs related to loading states, map display, and user feedback.

## Bug #1: CompactRings Loading Sequence
**Issue:** Recovery and Load rings appeared first, then Sleep appeared separately, instead of all three appearing as grey circles simultaneously.

**Root Cause:** The `allScoresReady` check only waited for score values to exist, not for ALL loading to complete. Sleep loading finished later, causing staggered appearance.

**Fix:** Updated `RecoveryMetricsSectionViewModel`:
- Added `isRecoveryLoading` and `isStrainLoading` properties (previously only tracked `isSleepLoading`)
- Modified `checkAllScoresReady()` to wait until ALL three loading states are complete: `!isRecoveryLoading && !isSleepLoading && !isStrainLoading`
- Added observers for recovery and strain loading states
- Now all three rings appear as grey circles simultaneously, then transition to scores together

**Files Modified:**
- `VeloReady/Features/Shared/ViewModels/RecoveryMetricsSectionViewModel.swift`

## Bug #2: Latest Ride Map Not Showing on Today Page
**Issue:** The 4x9 ride on the today page didn't display a map, leaving an empty space.

**Root Cause:** The `mapSection` in `LatestActivityCardV2` had no fallback UI when:
- `isLoadingMap` is false
- `mapSnapshot` is nil (map loading failed or no GPS data)

This resulted in an empty view with no visual feedback.

**Fix:** Added an `else` clause to `mapSection`:
- Shows a placeholder rectangle with a map icon and "Map not available" text
- Provides clear feedback when map data is unavailable
- Uses same styling as other placeholder states

**Files Modified:**
- `VeloReady/Features/Today/Views/Components/LatestActivityCardV2.swift`

## Bug #3: Activities List Map Loading Issues
**Issue:** 
1. Long lag before walking activity maps appeared
2. When filtering to cycling only and scrolling down, only top 4 rides showed preview maps
3. Maps only appeared after visiting detail page and returning

**Root Cause:** Map generation concurrency limit was set to 3 concurrent operations. With many activities in a list, only the first 3-4 cards could generate maps simultaneously, causing a queue and lag.

**Fix:** Increased `maxConcurrentGenerations` from 3 to 6 in `MapSnapshotService`:
- Doubles the concurrent map generation capacity
- Reduces wait time for cards further down in the list
- Still maintains memory safety by limiting concurrent operations
- Improves responsiveness when scrolling through activities

**Files Modified:**
- `VeloReady/Core/Services/Location/MapSnapshotService.swift`

## Bug #4: Fitness Trajectory Chart Missing Loading Indicator
**Issue:** Users didn't know when the Fitness Trajectory chart was calculating data (CTL/ATL/TSB), creating uncertainty about whether data was loading or missing.

**Root Cause:** No visual feedback during `TrainingLoadService.isLoading` state.

**Fix:** Added `titleAccessory` to `FitnessTrajectoryComponent`:
- Displays a small ProgressView (spinner) next to the heading while `trainingLoadService.isLoading` is true
- Scaled to 0.8 for subtle, non-intrusive appearance
- Automatically disappears when loading completes

**Files Modified:**
- `VeloReady/Features/Trends/Views/Components/FitnessTrajectoryComponent.swift`

## Testing Recommendations

### Bug #1 - CompactRings:
1. Launch app after fresh install
2. Verify all three rings (Recovery, Sleep, Load) appear as grey circles simultaneously
3. Verify all three transition to colored scores together (no staggered appearance)

### Bug #2 - Latest Ride Map:
1. Navigate to Today page
2. Verify latest ride card shows map OR "Map not available" placeholder
3. Test with indoor/virtual rides (should show no map section)
4. Test with outdoor rides that have GPS data (should show map)

### Bug #3 - Activities List Maps:
1. Navigate to Activities tab with 10+ activities
2. Scroll through list quickly
3. Verify maps load progressively without excessive lag
4. Filter to a specific activity type (e.g., cycling only)
5. Scroll down - verify all visible maps load within a few seconds

### Bug #4 - Fitness Trajectory Loading:
1. Navigate to ride detail page OR weekly report
2. Locate Fitness Trajectory chart
3. Pull to refresh or force reload
4. Verify spinner appears next to "Fitness Trajectory" heading while loading
5. Verify spinner disappears when chart displays

## Performance Impact
- **Bug #1:** No performance impact (logic change only)
- **Bug #2:** Minimal impact (adds fallback UI only when needed)
- **Bug #3:** Slight increase in memory usage during peak load (6 concurrent vs 3), but improves perceived performance
- **Bug #4:** Negligible impact (adds lightweight spinner)

## Status
âœ… All fixes implemented and ready for testing
